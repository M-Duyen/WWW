<!DOCTYPE html>
<html
    xmlns:th="http://www.thymeleaf.org"
    xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
>
    <head>
        <meta charset="UTF-8" />
        <title>Checkout</title>
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
    </head>

    <body class="p-4">
        <div class="container">
            <h1>Checkout</h1>

            <!-- Main form (keep product quantity inputs here) -->
            <form id="checkoutForm" th:action="@{/cart/checkout}" method="post">
                <h4>Items</h4>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Price</th>
                            <th>Quantity</th>
                            <th>Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="it : ${items}">
                            <td th:text="${it.product.name}">Name</td>
                            <td th:text="${it.product.price}">0.0</td>
                            <td>
                                <input
                                    type="hidden"
                                    name="productIds"
                                    th:value="${it.product.id}"
                                />
                                <input
                                    type="number"
                                    min="1"
                                    th:name="${'quantity_' + it.product.id}"
                                    th:value="${selectedQuantities[it.product.id] ?: it.quantity}"
                                    class="form-control"
                                    style="width: 100px"
                                />
                            </td>
                            <td th:text="${it.subtotal}">0.0</td>
                        </tr>
                    </tbody>
                </table>

                <div class="mb-3">
                    <strong>Total:</strong>
                    <span id="totalAmount" th:text="${total}">0.0</span>
                </div>

                <div class="d-flex gap-2">
                    <button
                        id="confirmBtn"
                        type="button"
                        class="btn btn-success"
                    >
                        Confirm Order
                    </button>
                    <a th:href="@{/cart}" class="btn btn-secondary"
                        >Back to Cart</a
                    >
                </div>

                <!-- Confirmation Modal (moved inside form so its inputs are submitted) -->
                <div
                    class="modal fade"
                    id="confirmModal"
                    tabindex="-1"
                    aria-hidden="true"
                >
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Confirm Order</h5>
                                <button
                                    type="button"
                                    class="btn-close"
                                    data-bs-dismiss="modal"
                                    aria-label="Close"
                                ></button>
                            </div>
                            <div class="modal-body">
                                <!-- Customer selection INSIDE modal (will be submitted) -->
                                <div class="mb-3">
                                    <label class="form-label">Customer</label>
                                    <select
                                        name="customerId"
                                        id="modalCustomerSelect"
                                        class="form-select"
                                    >
                                        <option value="">-- Select --</option>
                                        <!-- remove Guest option to force a logged-in customer selection or new customer entry -->
                                        <option
                                            th:each="c : ${customers}"
                                            th:value="${c.id}"
                                            th:text="${c.name}"
                                        >
                                            Customer
                                        </option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label"
                                        >Or enter new customer</label
                                    >
                                    <input
                                        id="modalNewName"
                                        type="text"
                                        name="newCustomerName"
                                        class="form-control mb-1"
                                        placeholder="Customer name"
                                    />
                                    <input
                                        id="modalNewEmail"
                                        type="email"
                                        name="newCustomerEmail"
                                        class="form-control"
                                        placeholder="Email (optional)"
                                    />
                                </div>

                                <p>
                                    <strong>Customer preview:</strong>
                                    <span id="modalCustomerPreview"></span>
                                </p>

                                <h6>Items</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Product</th>
                                                <th>Qty</th>
                                                <th>Price</th>
                                                <th>Subtotal</th>
                                            </tr>
                                        </thead>
                                        <tbody id="modalItems"></tbody>
                                    </table>
                                </div>
                                <p class="text-end">
                                    <strong>Total:</strong>
                                    <span id="modalTotal"></span>
                                </p>
                            </div>
                            <div class="modal-footer">
                                <button
                                    id="modalCancel"
                                    type="button"
                                    class="btn btn-secondary"
                                    data-bs-dismiss="modal"
                                >
                                    Cancel
                                </button>
                                <button
                                    id="modalConfirm"
                                    type="button"
                                    class="btn btn-primary"
                                    sec:authorize="hasAnyRole('CUSTOMER','ADMIN')"
                                >
                                    Confirm & Place Order
                                </button>
                                <a
                                    th:href="@{/login}"
                                    class="btn btn-primary"
                                    sec:authorize="isAnonymous()"
                                    >Login to place order</a
                                >
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        <script>
            (function () {
                const confirmBtn = document.getElementById('confirmBtn');
                const modalEl = document.getElementById('confirmModal');
                const modal = new bootstrap.Modal(modalEl);
                const modalCustomerPreview = document.getElementById(
                    'modalCustomerPreview',
                );
                const modalItems = document.getElementById('modalItems');
                const modalTotal = document.getElementById('modalTotal');

                confirmBtn.addEventListener('click', function () {
                    // Build customer preview from modal inputs (modal inputs are editable)
                    const sel = document.getElementById(
                        'modalCustomerSelect',
                    ).value;
                    let custText = '';
                    if (sel === '') {
                        const newName =
                            document.getElementById('modalNewName').value;
                        custText = newName ? newName + ' (new)' : 'Guest';
                    } else if (sel === '0') {
                        custText = 'Guest';
                    } else {
                        const opt = document.getElementById(
                            'modalCustomerSelect',
                        ).selectedOptions[0];
                        custText = opt ? opt.text : 'Customer #' + sel;
                    }
                    modalCustomerPreview.innerText = custText;

                    // Build items list from current table rows in the form
                    modalItems.innerHTML = '';
                    let total = 0;
                    // select the main items table rows (first table in form)
                    document
                        .querySelectorAll('form#checkoutForm table tbody tr')
                        .forEach(function (row) {
                            const name = row.cells[0].innerText.trim();
                            const price =
                                parseFloat(row.cells[1].innerText) || 0;
                            const qtyInput = row.querySelector(
                                'input[type="number"]',
                            );
                            const qty = qtyInput
                                ? parseInt(qtyInput.value) || 1
                                : 1;
                            const subtotal = price * qty;
                            total += subtotal;
                            const tr = document.createElement('tr');
                            tr.innerHTML = `<td>${name}</td><td>${qty}</td><td>${price}</td><td>${subtotal}</td>`;
                            modalItems.appendChild(tr);
                        });
                    modalTotal.innerText = total;
                    modal.show();
                });

                document
                    .getElementById('modalConfirm')
                    .addEventListener('click', function () {
                        // Submit the form (modal inputs are inside the form so customer values will be submitted)
                        document.getElementById('checkoutForm').submit();
                    });
            })();
        </script>
    </body>
</html>
